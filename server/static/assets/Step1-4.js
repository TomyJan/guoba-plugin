import{b as e,ad as s,d1 as n,d2 as t,w as o,o as a,f as l,k as r,j as i,v as p,s as m,b$ as d,c7 as u,x as c,aL as f}from"./index.js";import{B as b}from"./BasicForm.js";import{a as v}from"./hooks.js";import j from"./StepBtn.js";import"./index4.js";import"./index5.js";import"./useFormItem.js";import"./index3.js";import"./DeleteOutlined.js";import"./transButton.js";import"./index2.js";import"./useWindowSizeFn.js";import"./FullscreenOutlined.js";import"./upperFirst.js";import"./download.js";import"./index6.js";import"./index7.js";import"./uniqBy.js";import"./lodash.default.js";import"./throttle.js";import"./merge.js";const g={class:"step-box"},h=p("div",{class:"step-tip"},"迁移配置",-1),P={class:"basic-form",key:"trans-form"},x=e({__name:"Step1-4",emits:["prev","next"],setup(e,{emit:x}){const M=x,S=s("setPageLoading",n),y=t("a",{onClick:function(){const{noPass:e}=k.value.jsPluginInfo;e.length>0?R({title:"不兼容的插件",width:600,content:t("span",[...e.map((e=>t("span",[V("插件名称",e.file),t("br"),V("原因",e.reason,"#ff7e7e"),t("br"),V("第"+e.lineNum+"行",e.line),t("br"),t("br")])))]),onOk:C}):C()}},"查看详情"),w=t("a",{onClick:H},"重新检测"),I=[y,t(u,{type:"vertical"}),w],[J,{models:k,registerForm:B}]=v({nextBtn:{text:"开始迁移"},schemas:[{field:"moduleTool",label:"安装依赖",component:"Select",componentProps:{options:[{label:"不安装",value:"none"},{label:"pnpm (推荐)",value:"pnpm"},{label:"npm",value:"npm"},{label:"cnpm",value:"cnpm"},{label:"yarn",value:"yarn"}]},bottomHelpMessage:"选择安装依赖的方式及工具"},{field:"transferJsMode",label:"单文件JS插件",component:"Select",componentProps:{options:[{label:"不迁移",value:"none"},{label:"仅迁移兼容的",value:"passed"},{label:"迁移所有插件",value:"force"}]},bottomHelpMessage:"选择迁移“单文件JS插件”的方式"},{field:"transferJsInfo",label:"迁移详情",component:"Input",render:()=>{var e,s;const n=k.value.jsPluginInfo;let o=(null==(e=n.passed)?void 0:e.length)||0,a=(null==(s=n.noPass)?void 0:s.length)||0,l=o+a;if(0===l)return"未检测到JS插件";let r=`检测到 ${l} 个JS插件，`;return r+=0===a?"全部可以迁移。":0===o?"全部不兼容。":`其中 ${a} 个不兼容， ${o} 个可以迁移。`,t("div",{},[r,I])},bottomHelpMessage:"",ifShow:({model:e})=>null!=k.value.jsPluginInfo.passed&&"passed"===e.transferJsMode},{field:"rubbishClean",label:"过滤垃圾文件",component:"Switch",helpMessage:["垃圾文件指的是：","1. 生成图片导致的html文件缓存。","（即以html为后缀的文件）","仅清理这一项，其他文件不清理。"],bottomHelpMessage:"是否过滤“data”文件夹中的垃圾文件"},{field:"redisClean",label:"Redis清理",component:"Switch",helpMessage:"如果你扔想保留V2的Redis数据，则不要清理。",bottomHelpMessage:"仅清理V2版本遗留的redis缓存（谨慎）"}]},{emit:M});o((()=>k.value.transferJsMode),(e=>{"passed"===e&&null==k.value.jsPluginInfo.passed&&H()}),{immediate:!0});const{createSuccessModal:F,createWarningModal:R}=f();function H(){return e=this,s=null,n=function*(){S(!0,"正在分析JS插件");try{let e=yield c.get({url:"/v2-transfer/check-js"},{errorMessageMode:"modal"});k.value.jsPluginInfo.passed=e.passed,k.value.jsPluginInfo.noPass=e.noPass}finally{S(!1)}},new Promise(((t,o)=>{var a=e=>{try{r(n.next(e))}catch(s){o(s)}},l=e=>{try{r(n.throw(e))}catch(s){o(s)}},r=e=>e.done?t(e.value):Promise.resolve(e.value).then(a,l);r((n=n.apply(e,s)).next())}));var e,s,n}function C(){const{passed:e}=k.value.jsPluginInfo;e.length>0&&F({title:"可迁移的插件",width:600,content:t("span",["注意事项：",t("br"),"1. 可迁移仅代表Guoba没有检测到不兼容的写法，不代表不会存在包括但不限于依赖缺失、其他不兼容的写法等问题。",t("br"),"2. 迁移到V3后，这些插件会运行在Guoba提供的“兼容V2插件”的容器里运行，如果存在报错将会拒绝执行插件，所以不用担心因报错无法启动的问题。",t("br"),t("br"),...e.map((e=>t("span",[V("插件名称",e.file),t("br")])))])})}function V(e,s,n="#333"){return t("span",[t("span",{},e+"："),t("span",{style:{color:n}},s)])}return(e,s)=>(a(),l("div",g,[h,r(d,{name:"fade-slide",mode:"out-in",appear:""},{default:i((()=>[p("div",P,[r(m(b),{onRegister:m(B)},null,8,["onRegister"])])])),_:1}),r(j,{onRegister:m(J)},null,8,["onRegister"])]))}});export{x as default};
