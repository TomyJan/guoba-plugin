var e=(e,a,t)=>new Promise(((l,o)=>{var n=e=>{try{s(t.next(e))}catch(a){o(a)}},r=e=>{try{s(t.throw(e))}catch(a){o(a)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,r);s((t=t.apply(e,a)).next())}));import{a}from"./common.js";import{b as t,cX as l,r as o,J as n,K as r,e as s,o as i,f as u,k as c,j as v,l as d,v as m,m as p,F as f,aL as g}from"./index.js";const y={style:{"margin-bottom":"16px",display:"flex","align-items":"center"}},h=t({__name:"GuobaLoginForm",setup(t){const h=l(),{createMessage:b}=g(),k=o(!1),w=o(""),x=o(0),I=o(!1);function S(e){I.value=!0,x.value=e;const a=setInterval((()=>{x.value--,x.value<=0&&(clearInterval(a),x.value=0,I.value=!1,localStorage.removeItem("codeTimestamp"))}),1e3)}function T(){return e(this,null,(function*(){try{k.value=!0,yield h.loginCodeRequest(),b.success("验证码发送成功，请在控制台查收"),localStorage.setItem("codeTimestamp",Date.now().toString()),S(300)}catch(e){b.error("获取验证码失败")}finally{k.value=!1}}))}function _(){return e(this,null,(function*(){try{if(k.value=!0,!w.value)return void b.error("请输入验证码");const e=yield h.loginCodeCheck(w.value);(null==e?void 0:e.token)?(h.setToken(e.token),b.success("登录成功"),localStorage.removeItem("codeTimestamp"),yield a(500),window.location.reload()):b.error("登录失败")}catch(e){b.error("登录失败")}finally{k.value=!1}}))}return n((()=>{!function(){const e=localStorage.getItem("codeTimestamp");if(e){const a=300-Math.floor((Date.now()-Number(e))/1e3);a>0&&S(a)}}()})),r((()=>{I.value&&localStorage.setItem("codeTimestamp",(Date.now()-1e3*(300-x.value)).toString())})),(e,a)=>{const t=s("a-empty"),l=s("a-divider"),o=s("a-input"),n=s("a-button");return i(),u(f,null,[c(t,{style:{margin:"0 auto"}},{description:v((()=>[d("请以主人的身份，向你的机器人发送“#锅巴登录”指令进行登录。")])),_:1}),c(l,null,{default:v((()=>[d("或使用验证码登录")])),_:1}),m("div",y,[c(o,{style:{"flex-grow":"1","margin-right":"8px"},placeholder:"请输入验证码",value:w.value,"onUpdate:value":a[0]||(a[0]=e=>w.value=e),disabled:k.value},null,8,["value","disabled"]),c(n,{disabled:I.value,onClick:T},{default:v((()=>[d(p(I.value?`${x.value}秒`:"获取验证码"),1)])),_:1},8,["disabled"])]),c(n,{block:"",type:"primary",onClick:_,loading:k.value},{default:v((()=>[d(" 登录")])),_:1},8,["loading"])],64)}}});export{h as default};
